#!/bin/sh
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NY-CLI - Terminal-based Anime Streaming Client
# Version: 1.0.0
# Author: Anjishnu Sengupta
# Website: https://nyanime.tech
# Repository: https://github.com/AnjishnuSengupta/ny-cli
#
# Inspired by ani-cli, powered by nyanime backend
# Just install and run - no configuration needed!
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VERSION="1.0.0"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BACKEND CONFIGURATION (Pre-configured - no user setup needed)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# NyAnime Backend APIs
NYANIME_BASE="https://nyanime.tech"
ANIWATCH_API="https://nyanime-backend-v2.onrender.com"
CONSUMET_API="https://consumet-api-gs81.onrender.com"

# User agent
USER_AGENT="Mozilla/5.0 (X11; Linux x86_64; rv:121.0) Gecko/20100101 Firefox/121.0"

# Local storage directories (XDG compliant)
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ny-cli"
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/ny-cli"
DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/ny-cli"

# Files
AUTH_FILE="$CONFIG_DIR/auth"
HISTORY_FILE="$DATA_DIR/history"
PENDING_SYNC_FILE="$DATA_DIR/pending_sync"

# Player (can be overridden with NYCLI_PLAYER env var)
PLAYER="${NYCLI_PLAYER:-mpv}"

# Sync interval (seconds)
SYNC_INTERVAL=10

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COLORS & STYLING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ -t 1 ]; then
    RED='\033[1;31m'
    GREEN='\033[1;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[1;34m'
    MAGENTA='\033[1;35m'
    CYAN='\033[1;36m'
    WHITE='\033[1;37m'
    DIM='\033[2m'
    BOLD='\033[1m'
    RESET='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' MAGENTA='' CYAN='' WHITE='' DIM='' BOLD='' RESET=''
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ASCII ART BANNER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_banner() {
    clear
    printf '%b' "${MAGENTA}"
    cat << 'EOF'

    â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•      â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â•šâ•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘         â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
    â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•          â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•

EOF
    printf '%b' "${RESET}"
    printf '%b\n' "${DIM}${CYAN}         âŸ¨ Your Gateway to Anime Streaming âŸ©${RESET}"
    printf '%b\n' "${DIM}         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    printf '%b\n\n' "${DIM}         v${VERSION} ${RESET}${DIM}â€¢ ${CYAN}nyanime.tech${RESET}"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UI HELPERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print_line() {
    printf '%b\n' "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
}

msg() {
    printf '%b\n' "${CYAN}â–¸ ${WHITE}$1${RESET}"
}

msg_success() {
    printf '%b\n' "${GREEN}âœ“ ${WHITE}$1${RESET}"
}

msg_error() {
    printf '%b\n' "${RED}âœ— ${WHITE}$1${RESET}" >&2
}

msg_warn() {
    printf '%b\n' "${YELLOW}âš  ${WHITE}$1${RESET}"
}

msg_info() {
    printf '%b\n' "${BLUE}â„¹ ${WHITE}$1${RESET}"
}

prompt() {
    printf '%b' "${CYAN}â–¸ ${WHITE}$1${RESET}"
}

die() {
    msg_error "$1"
    exit 1
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UTILITY FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

check_deps() {
    for cmd in curl sed grep; do
        command -v "$cmd" >/dev/null 2>&1 || die "Missing required dependency: $cmd"
    done
    
    if ! command -v "$PLAYER" >/dev/null 2>&1; then
        if command -v mpv >/dev/null 2>&1; then
            PLAYER="mpv"
        elif command -v vlc >/dev/null 2>&1; then
            PLAYER="vlc"
        elif command -v iina >/dev/null 2>&1; then
            PLAYER="iina"
        else
            msg_warn "No video player found. Install mpv:"
            msg_info "  Arch: sudo pacman -S mpv"
            msg_info "  Ubuntu: sudo apt install mpv"
            msg_info "  macOS: brew install mpv"
        fi
    fi
}

init_dirs() {
    mkdir -p "$CONFIG_DIR" "$CACHE_DIR" "$DATA_DIR"
}

urlencode() {
    printf '%s' "$1" | curl -Gso /dev/null -w '%{url_effective}' --data-urlencode @- "" 2>/dev/null | cut -c 3- || printf '%s' "$1" | sed 's/ /%20/g'
}

open_url() {
    if command -v xdg-open >/dev/null 2>&1; then
        xdg-open "$1" 2>/dev/null &
    elif command -v open >/dev/null 2>&1; then
        open "$1" 2>/dev/null &
    elif command -v wslview >/dev/null 2>&1; then
        wslview "$1" 2>/dev/null &
    else
        msg_info "Open this URL: $1"
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# AUTHENTICATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

is_logged_in() {
    [ -f "$AUTH_FILE" ] && [ -s "$AUTH_FILE" ]
}

get_username() {
    is_logged_in && head -1 "$AUTH_FILE"
}

get_token() {
    is_logged_in && sed -n '2p' "$AUTH_FILE"
}

do_login() {
    printf "\n"
    printf '%b\n' "${MAGENTA}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    printf '%b\n' "${MAGENTA}â”‚${RESET}  ${BOLD}ğŸ” Login to NyAnime${RESET}                            ${MAGENTA}â”‚${RESET}"
    printf '%b\n' "${MAGENTA}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${RESET}"
    printf '%b\n' "${MAGENTA}â”‚${RESET}  1. Sign up/login at nyanime.tech              ${MAGENTA}â”‚${RESET}"
    printf '%b\n' "${MAGENTA}â”‚${RESET}  2. Go to your Profile page                    ${MAGENTA}â”‚${RESET}"
    printf '%b\n' "${MAGENTA}â”‚${RESET}  3. Copy the Token shown there                 ${MAGENTA}â”‚${RESET}"
    printf '%b\n' "${MAGENTA}â”‚${RESET}  4. Paste it here                              ${MAGENTA}â”‚${RESET}"
    printf '%b\n' "${MAGENTA}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    printf "\n"
    
    local login_url="https://www.nyanime.tech/signup"
    msg "Opening browser..."
    open_url "$login_url"
    
    msg_info "If browser didn't open, visit: ${login_url}"
    msg_info "After signing in, go to Profile to find your Token"
    printf "\n"
    
    prompt "Your username: "
    read -r username
    prompt "Paste token: "
    read -r token
    
    if [ -n "$username" ] && [ -n "$token" ]; then
        printf '%s\n%s\n' "$username" "$token" > "$AUTH_FILE"
        chmod 600 "$AUTH_FILE"
        printf "\n"
        msg_success "Welcome, ${username}! ğŸ‰"
        # Try to sync any pending watch history
        sync_pending_history
    else
        msg_error "Login cancelled"
    fi
}

do_logout() {
    if [ -f "$AUTH_FILE" ]; then
        local user
        user=$(get_username)
        rm -f "$AUTH_FILE"
        msg_success "Goodbye, ${user}!"
    else
        msg_info "Not logged in"
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WATCH HISTORY & CLOUD SYNC
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Check if online
is_online() {
    curl -s --connect-timeout 2 --max-time 3 "https://www.google.com" >/dev/null 2>&1
}

# Save watch progress to pending sync file (for offline support)
save_pending_sync() {
    local anime_id="$1" episode_id="$2" timestamp="$3" ep_num="$4"
    local sync_time
    sync_time=$(date +%s)
    
    # Remove existing entry for this anime
    [ -f "$PENDING_SYNC_FILE" ] && grep -v "^${anime_id}|" "$PENDING_SYNC_FILE" > "${PENDING_SYNC_FILE}.tmp" 2>/dev/null && mv "${PENDING_SYNC_FILE}.tmp" "$PENDING_SYNC_FILE"
    
    # Add new entry: anime_id|episode_id|timestamp|ep_num|sync_time
    printf '%s|%s|%s|%s|%s\n' "$anime_id" "$episode_id" "$timestamp" "$ep_num" "$sync_time" >> "$PENDING_SYNC_FILE"
}

# Sync pending history to Firestore
sync_pending_history() {
    [ ! -f "$PENDING_SYNC_FILE" ] && return 0
    [ ! -s "$PENDING_SYNC_FILE" ] && return 0
    
    is_logged_in || return 0
    is_online || return 0
    
    local token
    token=$(get_token)
    [ -z "$token" ] && return 0
    
    local synced=0
    local temp_file="${PENDING_SYNC_FILE}.syncing"
    
    # Process each pending entry
    while IFS='|' read -r anime_id episode_id timestamp ep_num sync_time; do
        [ -z "$anime_id" ] && continue
        
        # Send to backend API
        response=$(curl -s -X POST "${NYANIME_BASE}/api/cli/sync-watch" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${token}" \
            -d "{\"animeId\": \"${anime_id}\", \"episodeId\": \"${episode_id}\", \"timestamp\": ${timestamp}, \"episodeNum\": ${ep_num}}" \
            2>/dev/null)
        
        if printf '%s' "$response" | grep -q '"success"' 2>/dev/null; then
            synced=$((synced + 1))
        else
            # Keep failed entries for retry
            printf '%s|%s|%s|%s|%s\n' "$anime_id" "$episode_id" "$timestamp" "$ep_num" "$sync_time" >> "$temp_file"
        fi
    done < "$PENDING_SYNC_FILE"
    
    # Replace pending file with failed entries only
    if [ -f "$temp_file" ]; then
        mv "$temp_file" "$PENDING_SYNC_FILE"
    else
        rm -f "$PENDING_SYNC_FILE"
    fi
    
    [ $synced -gt 0 ] && msg_success "Synced $synced items to cloud"
}

# Background sync daemon (called during playback)
start_sync_daemon() {
    local anime_id="$1" episode_id="$2" ep_num="$3"
    
    # Create a background process that syncs every 10 seconds
    (
        while true; do
            sleep "$SYNC_INTERVAL"
            
            # Get current playback position (this is approximate since we can't query mpv easily)
            local current_ts
            current_ts=$(date +%s)
            
            # Save to pending sync
            save_pending_sync "$anime_id" "$episode_id" "$current_ts" "$ep_num"
            
            # Try to sync if online
            sync_pending_history >/dev/null 2>&1
        done
    ) &
    SYNC_PID=$!
}

stop_sync_daemon() {
    [ -n "${SYNC_PID:-}" ] && kill "$SYNC_PID" 2>/dev/null
    SYNC_PID=""
}

save_to_history() {
    local anime_id="$1" title="$2" episode="$3" episode_id="${4:-}"
    local timestamp
    timestamp=$(date +%s)
    
    # Save to local history
    [ -f "$HISTORY_FILE" ] && grep -v "^${anime_id}|" "$HISTORY_FILE" > "${HISTORY_FILE}.tmp" 2>/dev/null && mv "${HISTORY_FILE}.tmp" "$HISTORY_FILE"
    
    printf '%s|%s|%s|%s\n' "$anime_id" "$title" "$episode" "$timestamp" | cat - "$HISTORY_FILE" 2>/dev/null > "${HISTORY_FILE}.tmp" && mv "${HISTORY_FILE}.tmp" "$HISTORY_FILE" || printf '%s|%s|%s|%s\n' "$anime_id" "$title" "$episode" "$timestamp" > "$HISTORY_FILE"
    
    head -50 "$HISTORY_FILE" > "${HISTORY_FILE}.tmp" && mv "${HISTORY_FILE}.tmp" "$HISTORY_FILE"
    
    # Save to pending sync for cloud backup
    [ -n "$episode_id" ] && save_pending_sync "$anime_id" "$episode_id" "$timestamp" "$episode"
    
    # Try immediate sync if online
    sync_pending_history >/dev/null 2>&1 &
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ANIME API
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

search_anime() {
    local query encoded
    query="$1"
    encoded=$(urlencode "$query")
    
    msg "Searching..."
    
    curl -s "${ANIWATCH_API}/api/v2/hianime/search?q=${encoded}" -H "User-Agent: $USER_AGENT" 2>/dev/null | \
        tr '{' '\n' | grep '"id"' | while read -r line; do
            id=$(printf '%s' "$line" | sed -n 's/.*"id"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
            name=$(printf '%s' "$line" | sed -n 's/.*"name"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
            [ -n "$id" ] && [ -n "$name" ] && printf '%s|%s\n' "$id" "$name"
        done | head -20
}

get_episodes() {
    local anime_id="$1"
    
    msg "Loading episodes..."
    
    curl -s "${ANIWATCH_API}/api/v2/hianime/anime/${anime_id}/episodes" -H "User-Agent: $USER_AGENT" 2>/dev/null | \
        tr '{' '\n' | grep '"episodeId"' | while read -r line; do
            ep_id=$(printf '%s' "$line" | sed -n 's/.*"episodeId"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
            ep_num=$(printf '%s' "$line" | sed -n 's/.*"number"[[:space:]]*:[[:space:]]*\([0-9]*\).*/\1/p')
            title=$(printf '%s' "$line" | sed -n 's/.*"title"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
            [ -n "$ep_id" ] && [ -n "$ep_num" ] && printf '%s|%s|%s\n' "$ep_num" "$ep_id" "$title"
        done
}

get_stream() {
    local episode_id="$1" server="${2:-hd-1}" category="${3:-sub}"
    
    msg "Getting stream..."
    
    curl -s "${ANIWATCH_API}/api/v2/hianime/episode/sources?animeEpisodeId=${episode_id}&server=${server}&category=${category}" \
        -H "User-Agent: $USER_AGENT" 2>/dev/null | \
        grep -o '"url"[[:space:]]*:[[:space:]]*"[^"]*"' | head -1 | sed 's/.*"\([^"]*\)".*/\1/'
}

get_subtitles() {
    local episode_id="$1"
    
    curl -s "${ANIWATCH_API}/api/v2/hianime/episode/sources?animeEpisodeId=${episode_id}" \
        -H "User-Agent: $USER_AGENT" 2>/dev/null | \
        grep -o '"file"[[:space:]]*:[[:space:]]*"[^"]*\.vtt[^"]*"' | head -1 | sed 's/.*"\([^"]*\)".*/\1/'
}

get_trending() {
    msg "Fetching trending..."
    
    curl -s "${ANIWATCH_API}/api/v2/hianime/home" -H "User-Agent: $USER_AGENT" 2>/dev/null | \
        tr '{' '\n' | grep '"id"' | while read -r line; do
            id=$(printf '%s' "$line" | sed -n 's/.*"id"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
            name=$(printf '%s' "$line" | sed -n 's/.*"name"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
            [ -n "$id" ] && [ -n "$name" ] && printf '%s|%s\n' "$id" "$name"
        done | head -15
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VIDEO PLAYER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

play_video() {
    local url="$1" title="$2" subtitle="$3"
    
    [ -z "$url" ] && die "No stream available"
    
    msg_success "Starting playback..."
    printf '%b\n\n' "  ${DIM}${title}${RESET}"
    
    case "$PLAYER" in
        mpv*)
            if [ -n "$subtitle" ]; then
                $PLAYER --force-media-title="$title" --sub-file="$subtitle" "$url"
            else
                $PLAYER --force-media-title="$title" "$url"
            fi
            ;;
        vlc*) $PLAYER --meta-title="$title" --play-and-exit "$url" ;;
        iina*) $PLAYER --mpv-force-media-title="$title" "$url" ;;
        *) $PLAYER "$url" ;;
    esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN FEATURES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

do_search() {
    printf "\n"
    prompt "Search anime: "
    read -r query
    [ -z "$query" ] && return
    
    printf "\n"
    results=$(search_anime "$query")
    
    [ -z "$results" ] && msg_error "No results" && return
    
    printf '%b\n' "\n${CYAN}Results:${RESET}"
    print_line
    i=1
    printf '%s\n' "$results" | while IFS='|' read -r id title; do
        printf '%b\n' "  ${WHITE}$(printf '%2d' $i))${RESET} $title"
        i=$((i + 1))
    done
    print_line
    
    printf "\n"
    prompt "Select [1-20]: "
    read -r choice
    [ "$choice" = "q" ] && return
    
    selected=$(printf '%s\n' "$results" | sed -n "${choice}p")
    [ -z "$selected" ] && return
    
    anime_id=$(printf '%s' "$selected" | cut -d'|' -f1)
    anime_title=$(printf '%s' "$selected" | cut -d'|' -f2)
    
    watch_anime "$anime_id" "$anime_title"
}

watch_anime() {
    local anime_id="$1" anime_title="$2"
    
    printf "\n"
    episodes=$(get_episodes "$anime_id")
    [ -z "$episodes" ] && msg_error "No episodes" && return
    
    ep_count=$(printf '%s\n' "$episodes" | wc -l)
    
    printf '%b\n' "\n${CYAN}${anime_title}${RESET} ${DIM}(${ep_count} eps)${RESET}"
    print_line
    
    if [ "$ep_count" -gt 20 ]; then
        printf '%s\n' "$episodes" | head -10 | while IFS='|' read -r num id title; do
            printf '%b\n' "  ${WHITE}$(printf '%3s' "$num"))${RESET} Episode $num"
        done
        printf '%b\n' "  ${DIM}     ... ($((ep_count - 15)) more) ...${RESET}"
        printf '%s\n' "$episodes" | tail -5 | while IFS='|' read -r num id title; do
            printf '%b\n' "  ${WHITE}$(printf '%3s' "$num"))${RESET} Episode $num"
        done
    else
        printf '%s\n' "$episodes" | while IFS='|' read -r num id title; do
            printf '%b\n' "  ${WHITE}$(printf '%3s' "$num"))${RESET} Episode $num"
        done
    fi
    print_line
    
    printf "\n"
    prompt "Episode [1-$ep_count]: "
    read -r ep_choice
    [ "$ep_choice" = "q" ] && return
    
    ep_line=$(printf '%s\n' "$episodes" | grep "^${ep_choice}|")
    [ -z "$ep_line" ] && msg_error "Invalid" && return
    
    episode_id=$(printf '%s' "$ep_line" | cut -d'|' -f2)
    play_episode "$anime_id" "$anime_title" "$ep_choice" "$episode_id" "$episodes"
}

play_episode() {
    local anime_id="$1" anime_title="$2" ep_num="$3" episode_id="$4" episodes="$5"
    
    printf "\n"
    
    stream_url=$(get_stream "$episode_id")
    [ -z "$stream_url" ] && stream_url=$(get_stream "$episode_id" "hd-2")
    [ -z "$stream_url" ] && msg_error "No stream available" && return
    
    subtitle_url=$(get_subtitles "$episode_id")
    save_to_history "$anime_id" "$anime_title" "$ep_num" "$episode_id"
    
    # Start background sync daemon during playback
    start_sync_daemon "$anime_id" "$episode_id" "$ep_num"
    
    play_video "$stream_url" "${anime_title} - Episode ${ep_num}" "$subtitle_url"
    
    # Stop sync daemon after playback ends
    stop_sync_daemon
    
    # Final sync attempt
    sync_pending_history >/dev/null 2>&1 &
    
    printf "\n"
    print_line
    printf '%b\n' "  ${WHITE}n)${RESET} Next  ${WHITE}r)${RESET} Replay  ${WHITE}s)${RESET} Select  ${WHITE}q)${RESET} Quit"
    print_line
    prompt "Choice: "
    read -r choice
    
    case "$choice" in
        n)
            next_ep=$((ep_num + 1))
            next_line=$(printf '%s\n' "$episodes" | grep "^${next_ep}|")
            if [ -n "$next_line" ]; then
                next_id=$(printf '%s' "$next_line" | cut -d'|' -f2)
                play_episode "$anime_id" "$anime_title" "$next_ep" "$next_id" "$episodes"
            else
                msg_info "No more episodes"
            fi
            ;;
        r) play_episode "$anime_id" "$anime_title" "$ep_num" "$episode_id" "$episodes" ;;
        s) watch_anime "$anime_id" "$anime_title" ;;
    esac
}

do_continue() {
    [ ! -f "$HISTORY_FILE" ] && msg_info "No history yet" && return
    
    # Try to sync any pending history first
    sync_pending_history >/dev/null 2>&1
    
    printf '%b\n' "\n${CYAN}Continue Watching:${RESET}"
    print_line
    
    i=1
    head -10 "$HISTORY_FILE" | while IFS='|' read -r id title episode ts; do
        printf '%b\n' "  ${WHITE}$(printf '%2d' $i))${RESET} $title ${DIM}(Ep $episode)${RESET}"
        i=$((i + 1))
    done
    print_line
    
    printf "\n"
    prompt "Select: "
    read -r choice
    [ "$choice" = "q" ] && return
    
    selected=$(sed -n "${choice}p" "$HISTORY_FILE")
    [ -z "$selected" ] && return
    
    anime_id=$(printf '%s' "$selected" | cut -d'|' -f1)
    anime_title=$(printf '%s' "$selected" | cut -d'|' -f2)
    last_ep=$(printf '%s' "$selected" | cut -d'|' -f3)
    
    episodes=$(get_episodes "$anime_id")
    next_ep=$((last_ep + 1))
    next_line=$(printf '%s\n' "$episodes" | grep "^${next_ep}|")
    
    if [ -n "$next_line" ]; then
        msg_info "Continuing Episode ${next_ep}"
        episode_id=$(printf '%s' "$next_line" | cut -d'|' -f2)
        play_episode "$anime_id" "$anime_title" "$next_ep" "$episode_id" "$episodes"
    else
        watch_anime "$anime_id" "$anime_title"
    fi
}

do_recommendations() {
    printf "\n"
    trending=$(get_trending)
    [ -z "$trending" ] && msg_error "Failed to fetch" && return
    
    printf '%b\n' "\n${CYAN}ğŸ“š Trending:${RESET}"
    print_line
    
    i=1
    printf '%s\n' "$trending" | while IFS='|' read -r id title; do
        printf '%b\n' "  ${WHITE}$(printf '%2d' $i))${RESET} $title"
        i=$((i + 1))
    done
    print_line
    
    printf "\n"
    prompt "Select: "
    read -r choice
    [ "$choice" = "q" ] && return
    
    selected=$(printf '%s\n' "$trending" | sed -n "${choice}p")
    [ -z "$selected" ] && return
    
    anime_id=$(printf '%s' "$selected" | cut -d'|' -f1)
    anime_title=$(printf '%s' "$selected" | cut -d'|' -f2)
    watch_anime "$anime_id" "$anime_title"
}

do_random() {
    printf "\n"
    msg "Finding random anime..."
    
    trending=$(get_trending)
    [ -z "$trending" ] && msg_error "Failed" && return
    
    count=$(printf '%s\n' "$trending" | wc -l)
    idx=$(awk 'BEGIN { srand(); print int(rand() * '"$count"') + 1 }')
    selected=$(printf '%s\n' "$trending" | sed -n "${idx}p")
    
    anime_id=$(printf '%s' "$selected" | cut -d'|' -f1)
    anime_title=$(printf '%s' "$selected" | cut -d'|' -f2)
    
    printf '%b\n\n' "\n${YELLOW}ğŸ² Random:${RESET} ${WHITE}${anime_title}${RESET}"
    prompt "Watch? [Y/n]: "
    read -r ans
    
    case "$ans" in
        [nN]*) return ;;
        *)
            episodes=$(get_episodes "$anime_id")
            first=$(printf '%s\n' "$episodes" | head -1)
            [ -n "$first" ] && {
                ep_id=$(printf '%s' "$first" | cut -d'|' -f2)
                play_episode "$anime_id" "$anime_title" "1" "$ep_id" "$episodes"
            }
            ;;
    esac
}

show_profile() {
    is_logged_in || { msg_info "Not logged in"; return; }
    
    local username
    username=$(get_username)
    
    printf '%b\n' "\n${MAGENTA}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    printf '%b\n' "${MAGENTA}â”‚${RESET}  ${BOLD}ğŸ‘¤ ${username}${RESET}"
    printf '%b\n\n' "${MAGENTA}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    
    # Show sync status
    if [ -f "$PENDING_SYNC_FILE" ] && [ -s "$PENDING_SYNC_FILE" ]; then
        local pending_count
        pending_count=$(wc -l < "$PENDING_SYNC_FILE")
        printf '%b\n' "  ${YELLOW}â³ ${pending_count} items pending sync${RESET}"
        printf '%b\n\n' "  ${DIM}Will sync when online${RESET}"
    fi
    
    printf '%b\n\n' "  ${WHITE}1)${RESET} Logout  ${WHITE}2)${RESET} Sync Now  ${WHITE}3)${RESET} Back"
    prompt "Choice: "
    read -r c
    case "$c" in
        1) do_logout ;;
        2) msg "Syncing..."; sync_pending_history ;;
    esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HELP & MENUS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_help() {
    printf '%b\n' "
${BOLD}NY-CLI${RESET} v${VERSION} - Terminal Anime Streaming

${CYAN}USAGE:${RESET}  ny-cli [OPTIONS] [QUERY]

${CYAN}OPTIONS:${RESET}
    -s, --search <q>    Search anime
    -c, --continue      Continue watching  
    -r, --random        Random anime
    -t, --trending      Show trending
    -l, --login         Login
    -L, --logout        Logout
    -h, --help          Help
    -v, --version       Version

${CYAN}EXAMPLES:${RESET}
    ny-cli                  Interactive mode
    ny-cli \"one piece\"      Quick search
    ny-cli -c               Continue watching

${CYAN}PLAYER CONTROLS (mpv):${RESET}
    Space  Play/Pause    f  Fullscreen
    â†/â†’    Seek 5s       q  Quit
    â†‘/â†“    Seek 60s      v  Subtitles
"
}

main_menu() {
    while true; do
        show_banner
        
        if is_logged_in; then
            local username
            username=$(get_username)
            printf '%b\n\n' "${CYAN}Welcome, ${WHITE}${username}${CYAN}! ğŸ‰${RESET}"
            
            printf '%b\n' "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}1)${RESET} ğŸ‘¤ Profile                         ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}2)${RESET} â–¶ï¸  Continue Watching               ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}3)${RESET} ğŸ” Search                          ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}4)${RESET} ğŸ“š Trending                        ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}5)${RESET} ğŸ² Random                          ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}h)${RESET} â“ Help                            ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}q)${RESET} ğŸšª Exit                            ${CYAN}â”‚${RESET}"
            printf '%b\n\n' "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
            prompt "Choice: "
            read -r c
            
            case "$c" in
                1) show_profile ;;
                2) do_continue ;;
                3) do_search ;;
                4) do_recommendations ;;
                5) do_random ;;
                h|H) show_help; printf '%b' "\n${DIM}Press Enter...${RESET}"; read -r _ ;;
                q|Q) printf '%b\n\n' "\n${MAGENTA}Sayonara! ğŸ‘‹${RESET}"; exit 0 ;;
            esac
        else
            printf '%b\n\n' "${CYAN}Welcome! Sign in for all features.${RESET}"
            
            printf '%b\n' "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}1)${RESET} ğŸ” Search                          ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}2)${RESET} ğŸ“š Trending                        ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}3)${RESET} ğŸ” Login                           ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}h)${RESET} â“ Help                            ${CYAN}â”‚${RESET}"
            printf '%b\n' "${CYAN}â”‚${RESET}  ${WHITE}q)${RESET} ğŸšª Exit                            ${CYAN}â”‚${RESET}"
            printf '%b\n\n' "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
            prompt "Choice: "
            read -r c
            
            case "$c" in
                1) do_search ;;
                2) do_recommendations ;;
                3) do_login ;;
                h|H) show_help; printf '%b' "\n${DIM}Press Enter...${RESET}"; read -r _ ;;
                q|Q) printf '%b\n\n' "\n${MAGENTA}Sayonara! ğŸ‘‹${RESET}"; exit 0 ;;
            esac
        fi
    done
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ENTRY POINT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

main() {
    check_deps
    init_dirs
    
    case "${1:-}" in
        -h|--help) show_help; exit 0 ;;
        -v|--version) printf "ny-cli %s\n" "$VERSION"; exit 0 ;;
        -l|--login) show_banner; do_login; exit 0 ;;
        -L|--logout) do_logout; exit 0 ;;
        -c|--continue) show_banner; do_continue; exit 0 ;;
        -r|--random) show_banner; do_random; exit 0 ;;
        -t|--trending) show_banner; do_recommendations; exit 0 ;;
        -s|--search)
            shift
            show_banner
            [ -n "$1" ] && {
                results=$(search_anime "$*")
                [ -n "$results" ] && {
                    printf '%b\n' "\n${CYAN}Results:${RESET}"
                    print_line
                    i=1
                    printf '%s\n' "$results" | while IFS='|' read -r id title; do
                        printf '%b\n' "  ${WHITE}$(printf '%2d' $i))${RESET} $title"
                        i=$((i + 1))
                    done
                    print_line
                    printf "\n"
                    prompt "Select: "
                    read -r c
                    selected=$(printf '%s\n' "$results" | sed -n "${c}p")
                    [ -n "$selected" ] && watch_anime "$(printf '%s' "$selected" | cut -d'|' -f1)" "$(printf '%s' "$selected" | cut -d'|' -f2)"
                } || msg_error "No results"
            }
            exit 0
            ;;
        "")
            main_menu
            ;;
        *)
            show_banner
            results=$(search_anime "$*")
            [ -n "$results" ] && {
                printf '%b\n' "\n${CYAN}Results:${RESET}"
                print_line
                i=1
                printf '%s\n' "$results" | while IFS='|' read -r id title; do
                    printf '%b\n' "  ${WHITE}$(printf '%2d' $i))${RESET} $title"
                    i=$((i + 1))
                done
                print_line
                printf "\n"
                prompt "Select: "
                read -r c
                selected=$(printf '%s\n' "$results" | sed -n "${c}p")
                [ -n "$selected" ] && watch_anime "$(printf '%s' "$selected" | cut -d'|' -f1)" "$(printf '%s' "$selected" | cut -d'|' -f2)"
            } || msg_error "No results"
            exit 0
            ;;
    esac
}

main "$@"
